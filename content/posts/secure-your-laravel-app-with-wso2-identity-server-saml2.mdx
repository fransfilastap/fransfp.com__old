---
slug: secure-your-laravel-app-with-wso2-identity-server-saml2
title: "Secure Your Laravel Application with  WSO2 Identity Server - SAML2 Protocol "
date: 2022-01-09
author: fransfp
tags:
  - laravel
---


# **Introduction**

## Laravel

Laravel is no doubt is the most popular PHP framework. Laravel is highly expressive with security feature included. It is also highly flexible and evolves with lates web development trends.

It will take only few minutes to booting up a simple web app including its authentication mechanism (you can use Laravel Breeze, Jetstream, or Fortify) just using Laravel Artisan Command and Eloquent ORM.

## SAML2

SAML2 (Security Assertion Markup Language 2.0) is a version of the SAML standard for exchanging authentication and authorization identities between security domain (app). SAML2 uses security tokens containing assertions and user information in XML-based document. SAML2 enabling web-based, cross-domain SSO, which helps to reduce administrative overhead to user, by reducing credential information input in each security domain.

## Identity Server

The Identity Server is a server that manages securely identities such as employees, suppliers, partners, customers, etc. (any type of information that can be stored in a database as an entity has an identity); and access between systems and applications, with the possibility of using a single access and without the need to repeat credentials every time a user needs to use a Service Provider.

WSO2 Identity Server is one of IAM product with API-driven, open-source, cloud-native feature. It is so easy to implement SSO authentication using WSO2 IS.

![source : wso2.com](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/fa4276f6-dff8-42ac-89e8-675537b56505/Untitled.png)

source :¬†[wso2.com](http://wso2.com/)

# Terms Glossary

In order to understand this tutorial, i think it‚Äôs necessary for you to familiarize with some basic concepts, as explained below:

idP = Identity Provider is a system thant is able to identify the user and issue the signed SAML document

SP = Service Provider is a system that receives SAML XML. It‚Äôs can be your app.

Metadata = an XML document that contains information about the idP dan SP. idP issues XML metadata when a SP registers the app.

SSO = Single Sign On: an authentication process that enables users to use unique credentials across various applications within an organization.

I separated this article into three parts. Part 1 will cover laravel setup. Part 2 will cover wso2 identity server setup. Part 3 will connecting part 1 and part 2 to finalize the app login.

# Part 1 : Laravel Setup

1. Create new Laravel App (you can skip this if you had your project setup-ed)

   ```php

   ```
2. Install laravel-saml2 library. You can read the documentation here.¬†<https://github.com/aacotroneo/laravel-saml2>

   ```php

   ```
3. Publish laravel-saml2 config file. This will add the files¬†`app/config/saml2_settings.php`&¬†`app/config/saml2/mytestidp1_idp_settings.php`, which you will need to customize.

   ```php

   ```
4. Define names of all the IDPs you want to configure in¬†`app/config/saml2_settings.php`¬†. The name of the IDP will show up in the URL used by the Saml2 routes the library makes, as well as internally in the filename for each IDP's config.

```php

```

1. Set¬†`$this_idp_env_id = 'WSO2IS'`¬†or any value, then you can set ENV vars starting with¬†`SAML2_WSO2IS_`¬†¬†respectively.

```php

```

1. In order to make single logout work properly, I need to extend Saml2Controller which provided by the library.

```php

```

### üëåüèª¬†Laravel Fortify vs Manual Authentication

Laravel offers two different authentication mechanism. Using Laravel Fortify your life will be easier. Laravel Fortify is a frontend agnostic authentication backend implementation for Laravel. Fortify registers the routes and controllers needed to implement all of Laravel's authentication features, including login, registration, password reset, email verification, and more. Nonetheless, wether Fortify or manual authentication, it will not be that much different.

1. (Optional) Install Laravel Jetstream. I use this starter pack for this article purpose (because i love this starter pack ü§£)

   ```php

   ```

   After installing the Jetstream package, you may execute the¬†`jetstream:install`¬†Artisan command. This command accepts the name of the stack you prefer (`livewire`¬†or¬†`inertia`). I prefer livewire.

   ```php

   ```

   Then finalizing the installation

   ```php

   ```
2. Now we‚Äôre done setup Laravel Jetstream with Livewire.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/1082462b-4486-4d05-8005-b7537d1ef88d/Untitled.png)

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/e202fd09-4f6c-409b-964a-16941fe845e0/Untitled.png)

# Part 2: WSO2 Identity Server Setup

Make sure you have JDK 8 or 11 installed in your server. If you have it installed you can continue to install WSO2 Identity server. Download the installer at

[Identity Server - On-Premise and in the Cloud](https://wso2.com/identity-server/)

1. Start the WSO2 Identity Server and go to¬†[](https://localhost:9443/carbon)<https://localhost:9443/carbon>¬†to access management console.

```bash

```

1. Create new Service Provider

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/21969531-f73c-4a2d-a9ee-66fbcfa46b56/Untitled.png)

Click register to add new service provider. The service provider screen will appear.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/6964cc7a-2a9c-47cc-ae0a-e7584e719ad5/Untitled.png)

We need to upload certificate. Follow the steps bellow.

* Go to the folder within the WSO2 Identity Server version¬†*/repository/resources/security*
* Open a terminal and execute the following commands to export the keystone certificate.
* The exported certificate will be in binary format.

```bash

```

Convert the previous binary encrypted certificate to a PEM encrypted certificate.

```bash

```

* Upload pem file to service provider.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/657ffbbe-18d8-4240-95ad-5907c66abcc9/Untitled.png)

* Claim configuration : wso2 local claim will be used. Givenname and emailaddress need to be added.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/c65a21bf-b3c1-4561-913c-d5f2227fa651/Untitled.png)

* Inbound Authentication Configuration: the responsibility of the inbound authenticator component is to identify and analyze all inbound authentication requests and then generate the corresponding response.

  To configure Inbound Authentication, on SAML2 Web SSO Section click on the Configure button, which will redirect you to the form that will request the information necessary to establish the connection between WSO2 Identity Server and the application that has been previously generated.

  Complete the form with the following information:

  [Untitled](https://www.notion.so/c689819fcefc44d1a68f4968675ae6fb)

  Then, click on the Update button to update the information in the Service Provider.

  ![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/9e628763-8293-4a0e-afd6-06a27aa13b0b/Untitled.png)

  ![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/027db414-c927-42ff-ad4c-8d966b24fc4c/Untitled.png)

  # Part 3: Connecting WSO2 User to Laravel User

  First, create new user in WSO2 Management Console. To create new user in WSO2 ,the following steps must be followed:

  * Click on Add, under Users and Roles.
  * Click on Add New User, on the page where the console was redirected.
  * You will be asked to fill out a form which contains basic user information, such as Username and Password

  ![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/7154c21a-ac7c-4279-8c48-33470d8dc680/Untitled.png)

  * Click finish.

  ![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/989226c4-2620-4ac5-839f-a13dce69c2c3/Untitled.png)

  * Fill some field in User Profile

  ![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/2db01346-3e21-4f5a-9744-bbc1eaa14ab4/Untitled.png)

  ![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/df28b304-c5b4-4c19-81c3-15654ae1547f/Untitled.png)

  * Create Event Listener to catch ‚Äúlogged in‚Äù event from WSO2 IS. Add this code to app\Providers\EventServiceProvider.php

  ```php

  ```

  * Create an action class to ‚Äúsynchronize‚Äù laravel user with WSO2 IS user. Create class in¬†**app/actions**¬†folder.

  ```php

  ```

  ```php

  ```

  These classes will synchronize laravel user data with WSO2 IS user data every time user logged in to laravel application.

  At this state, your laravel application should connected to WSO2 IS. BUT, we need some additional configuration to make laravel save authenticated session correctly by using ‚Äúlaravel way‚Äù. Edit saml2_config.php file and define ‚ÄúroutesMiddleware‚Äù.

  ```php

  ```

  * Then create new middleware entry at app\Http\Kernel.php

  ```php

  ```

  Now this Laravel Application will generate session for authenticated user correctly. BUT We are not done yet. Many time your user maybe authenticated on other service provider in your organization. In this case laravel should ask WSO2 IS first wether the users is authenticated or not. If authenticated then we should bypass them.

  * Create new middleware by using this command :

  ```bash

  ```

  * Open the file and add code bellow :

  ```php

  ```

  * Then register this new middleware to app\Http\Kernel.php

  ```php

  ```

  * Apply the middleware to your routes/web.php.

  ```php

  ```

  Next, modify your login page. It should be just a landing page which as a button or link to redirect your app authentication to WSO2 IS login page. In this article i made it just like this :

  ![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/bd974b0c-fb1e-47b7-af41-6682220e1922/Untitled.png)

  ```php

  ```

  Focus at route(‚Äôsaml2_login‚Äô,\[‚Äôwso2is‚Äô]). This route name is defined by laravel-saml library. Use this route with your defined ‚ÄúidpNames‚Äù in saml2_settings.php file. You must use route saml2_logout too to logout the app.

  ## Results and Conclusions

  As you walk along this tutorial, using laravel (jetstream) you can establish a connection using the SAML2 to WSO2 IS. It‚Äôs very simple and fast in development.

  ![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/41a4ea89-2d37-4a3f-94e4-1d8e86d2998d/Untitled.png)

  ![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/d2204276-1687-4b9e-9699-6472eaf7fe99/Untitled.png)

  Clone this repository to see complete the source code of this article.

  [](https://github.com/fransfilastap/laravel-wso2is)<https://github.com/fransfilastap/laravel-wso2is>